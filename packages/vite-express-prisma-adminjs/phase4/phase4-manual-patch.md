# Phase 4: Manual Patch — Vite + Express + Prisma + AdminJS

If you prefer to apply Phase 4 by hand instead of `git apply`, follow these steps. The base code is Phase 3 only (Deal + AdminUser, no Contact).

## 1. Prisma schema

**File:** `prisma/schema.prisma`

After the `AdminUser` model (before `model Deal {`), add the Contact model. In the Deal model add `contacts DealContact[]`. After the Deal model add the DealContact model (dealId, contactId, relations, @@id([dealId, contactId])).

## 2. API routes and AdminJS

**File:** `api/index.ts`

- Add `import AdminJS, { ComponentLoader } from "adminjs"` and `import { join } from "path"`.
- Create `ComponentLoader`, add `ManageDealContacts` and `ManageContactDeals` from `join(process.cwd(), "api", "admin", "ManageDealContacts")` (and ManageContactDeals).
- Add `recordHandler` that returns `{ record: record.toJSON(currentAdmin) }`.
- Add Contact resource with **Manage deals** action. Add **Manage contacts** action to Deal. **Do not** add DealContact.
- Call `admin.watch()` when `NODE_ENV !== "production"`.
- Add routes: GET /api/deals, GET /api/deals/:id, GET /api/contacts, GET /api/contacts/:id, POST /api/deals/:id/contacts, DELETE /api/deals/:id/contacts/:contactId.
- Update POST /api/deals to accept optional `contact` and create nested contact when present.

**Files:** Create `api/admin/ManageDealContacts.tsx` and `api/admin/ManageContactDeals.tsx` — React components that fetch data, display lists with Remove buttons, and dropdowns to add. Use plain HTML elements (div, button, label, select) with inline styles — do not use `@adminjs/design-system` (causes resolution errors with tsx).

## 3. NewDeal form

**File:** `src/pages/NewDeal.tsx`

Add state for contactName, contactEmail, contactPhone. In submit, add optional `contact` to the body when all three are set. Add "Primary Contact (optional)" section with three inputs.

## 4. .gitignore

Add `api/.adminjs/` to ignore the AdminJS-generated bundle.

---

After editing, run:

```bash
npm run db:push
npm run dev
```

The `api/.adminjs/` folder is generated by AdminJS on first run — do not commit it.
