# Phase 4: Manual Patch — NestJS + Vite React + AdminJS

If you prefer to apply Phase 4 by hand instead of `git apply`, follow these steps. The base code is Phase 3 only (Deal + AdminUser, no Contact).

## 1. Prisma schema

**File:** `prisma/schema.prisma`

After the `AdminUser` model (before `model Deal {`), add:

```prisma
model Contact {
  id        String   @id @default(cuid())
  name      String
  email     String
  phone     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deals     DealContact[]
}
```

In the `Deal` model, add the relation and then add the join model. Change `model Deal` to include:

```prisma
  contacts    DealContact[]
}

model DealContact {
  dealId    String
  contactId String
  deal      Deal    @relation(fields: [dealId], references: [id], onDelete: Cascade)
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  @@id([dealId, contactId])
}
```

## 2. Contacts module and API

**Files:** Create `api/src/contacts/contacts.controller.ts`, `contacts.service.ts`, `contacts.module.ts`.

- **ContactsController** — `@Controller('api/contacts')`, `@Get()` list (use service.findAll), `@Get(':id')` getOne (use service.findOne).
- **ContactsService** — `findAll()` returns `prisma.contact.findMany({ orderBy: { name: 'asc' } })`; `findOne(id)` returns contact with `deals` included (include `deals: { include: { deal: true } }` and map to `deals: c.deals.map(dc => dc.deal)`).
- **ContactsModule** — Import PrismaModule, register controller and service.
- **AppModule** — Add `ContactsModule` to imports.

## 3. Deals controller and service

**File:** `api/src/deals/deals.controller.ts`

- Add `@Get(':id')` before `@Post()` — `getOne(@Param('id') id)` returning `this.deals.findOne(id)`.
- Change `create` body type to include `contact?: { name: string; email: string; phone: string }`.
- Add:

```ts
  @Post(':id/contacts')
  addContact(@Param('id') dealId: string, @Body() body: { contactId: string }) {
    return this.deals.addContact(dealId, body.contactId);
  }

  @Delete(':id/contacts/:contactId')
  removeContact(@Param('id') dealId: string, @Param('contactId') contactId: string) {
    return this.deals.removeContact(dealId, contactId);
  }
```

**File:** `api/src/deals/deals.service.ts`

- Add `findOne(id)` with `include: { contacts: { include: { contact: true } } }`, map to `contacts: d.contacts.map(dc => dc.contact)`.
- In `findAll()`, add same include and mapping.
- In `create()`, accept optional `contact`, build `Prisma.DealCreateInput` with optional `contacts: { create: [{ contact: { create: contact } }] }` when contact is present.
- Add `addContact(dealId, contactId)` and `removeContact(dealId, contactId)` (prisma.dealContact.create / delete).

## 4. AdminJS resources and custom actions

**File:** `api/src/main.ts`

- Add `ComponentLoader`, use `path.join(__dirname, '..', 'src', 'admin', 'ManageDealContacts')` (and ManageContactDeals) — path must point to source .tsx since Nest compiles to dist/.
- Add custom record actions: **Manage contacts** on Deal, **Manage deals** on Contact. Handler must return `{ record: record.toJSON(currentAdmin) }`.
- Add Contact to resources. **Do not** add DealContact.
- Call `admin.watch()` when `NODE_ENV !== 'production'` so custom components are bundled.

**Files:** Create `api/src/admin/ManageDealContacts.tsx` and `ManageContactDeals.tsx` — React components that fetch deal/contact and all contacts/deals, display lists with Remove buttons, and dropdowns to add. Use `POST /api/deals/:id/contacts` and `DELETE /api/deals/:id/contacts/:contactId`.

## 5. tsconfig and NewDeal form

**File:** `api/tsconfig.json`

- Add `"exclude": ["node_modules", "dist", "src/admin"]` so TSX components are not compiled by Nest (AdminJS bundles them).

**File:** `src/pages/NewDeal.tsx`

- Add state: `contactName`, `contactEmail`, `contactPhone`.
- In `submit`, build `body` with optional `contact: { name, email, phone }` when all three are set.
- Add a "Primary Contact (optional)" section with three inputs.

---

After editing, run:

```bash
npm run db:push
npm run dev
```

The `api/.adminjs/` folder is generated by AdminJS on first run — do not commit it.
